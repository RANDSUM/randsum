name: Publish + Release
on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

env:
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  setup:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: oven-sh/setup-bun@v1
      - run: bun install
      - run: bun run build:all

  publish:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: core
            needs: []
          - name: notation
            needs: [core]
          - name: dice
            needs: [core, notation]
          - name: 5E
            needs: [dice]
          - name: root-rpg
            needs: [dice]
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - name: Setup .npmrc
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          echo "access=public" >> .npmrc
      - name: Wait for dependencies
        if: matrix.needs != ''
        run: |
          for dep in ${{ join(matrix.needs, ' ') }}; do
            while ! npm view "@randsum/$dep" version; do
              echo "Waiting for @randsum/$dep to be published..."
              sleep 10
            done
          done
      - name: Publish ${{ matrix.name }}
        run: bun publish --no-git-checks --cwd packages/${{ matrix.name }}
