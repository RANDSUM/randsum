name: Publish + Release
on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

env:
  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

jobs:
  setup:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
      - run: bun install
      - run: bun run build:all

  publish:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: core
            needs: []
          - name: notation
            needs: [core]
          - name: dice
            needs: [core, notation]
          - name: 5e
            needs: [dice]
          - name: root-rpg
            needs: [dice]
          - name: blades
            needs: [dice]
          - name: salvageunion
            needs: [dice]
      fail-fast: false
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      - name: Setup .npmrc
        run: |
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > .npmrc
          echo "access=public" >> .npmrc
      - name: Wait for dependencies
        if: matrix.needs != ''
        continue-on-error: true
        run: |
          for dep in ${{ join(matrix.needs, ' ') }}; do
            max_attempts=30
            attempt=1
            while ! npm view "@randsum/$dep" version; do
              if [ $attempt -ge $max_attempts ]; then
                echo "Max attempts reached waiting for @randsum/$dep. Continuing anyway..."
                break
              fi
              echo "Waiting for @randsum/$dep to be published... (Attempt $attempt/$max_attempts)"
              sleep 10
              attempt=$((attempt + 1))
            done
          done
      - name: Publish ${{ matrix.name }}
        continue-on-error: true
        run: |
          if ! bun publish --no-git-checks --cwd packages/${{ matrix.name }}; then
            echo "::warning::Failed to publish @randsum/${{ matrix.name }}, but continuing with workflow"
          fi
